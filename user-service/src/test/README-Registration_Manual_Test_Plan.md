## Manual test plan — Registration flow (step-by-step)

| ID  | Test case                                     |                                                                   Preconditions | Steps                                                                                                                     | Expected result / pass criteria                                                                                                                                                                                                                                                                     | Notes         |
| --- | --------------------------------------------- | ------------------------------------------------------------------------------: | ------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- |
| T01 | Validation — missing username                 |                                                                      Service up | 1. POST `/api/register` with body: `{ "username": "", "password":"pass123", "email":"a@x.com", "referralCode":"REF123" }` | API returns error (400 / BadCredentialsException). No pending user created.                                                                                                                                                                                                                         | High priority |
| T02 | Validation — missing password                 |                                                                      Service up | 1. POST `/api/register` with password blank                                                                               | Error returned; no pending saved.                                                                                                                                                                                                                                                                   | High          |
| T03 | Validation — missing email                    |                                                                      Service up | 1. POST `/api/register` with email blank                                                                                  | Error returned; no pending saved.                                                                                                                                                                                                                                                                   | High          |
| T04 | Validation — missing referral code            |                                                                      Service up | 1. POST `/api/register` with referralCode blank                                                                           | Error returned; no pending saved.                                                                                                                                                                                                                                                                   | High          |
| T05 | Username already exists                       |                            A permanent user with username `existingUser` exists | 1. POST with username `existingUser`                                                                                      | Error returned saying username exists; no OTP created.                                                                                                                                                                                                                                              | High          |
| T06 | Email already exists                          |                               A permanent user with email `exists@x.com` exists | 1. POST with that email                                                                                                   | Error returned saying email exists; no OTP created.                                                                                                                                                                                                                                                 | High          |
| T07 | Referral code invalid                         |                                                   No user has referral `BADREF` | 1. POST with referralCode `BADREF`                                                                                        | Error returned "referralCode is invalid"; no pending saved.                                                                                                                                                                                                                                         | High          |
| T08 | Happy path — create pending + OTP send        |                               Referral `REF123` exists; username/email not used | 1. POST `/api/register` with valid data (username `testuser`, email `test@example.com`, referral `REF123`)                | 200 + OtpSession payload returned; PendingUser stored with hashed password; OTP sent (email channel). Verify OTP sessionId present and pendingRepo has record.                                                                                                                                      | High          |
| T09 | Resend OTP when pending active                |                                       PendingUser exists and OTP session active | 1. Repeat POST with same username/email while session active                                                              | Service increments attempts (not exceeding max) and **resends** OTP (same sessionId). No duplicate pending record.                                                                                                                                                                                  | Medium        |
| T10 | Expired pending cleaned & new pending created |                                        PendingUser exists but older than expiry | 1. POST with same username/email                                                                                          | Old pending deleted; new PendingUser created; new OTP session returned.                                                                                                                                                                                                                             | Medium        |
| T11 | Complete registration — valid OTP             |                                          PendingUser exists; OTP session active | 1. POST `/api/register/verify` with `{sessionId: "sid", otp:"123456"}` (valid OTP)                                        | User persisted in `userRepo`; PendingUser deleted; OTP session invalidated; auth token issued (AuthResponse); `UserRegisteredEvent` published; if referrer exists → `userHierarchyService.updateHierarchy(referrerId, newUserId)` called; default role assigned; default rank set (e.g., `RANK_0`). | High          |
| T12 | Complete registration — invalid OTP           |                                          PendingUser exists; OTP session active | 1. POST `/api/register/verify` with wrong OTP                                                                             | Error returned (BadCredentialsException); pending remains; attempts incremented. When attempts exceed max → TooManyOtpAttemptsException behavior should be observed.                                                                                                                                | High          |
| T13 | OTP attempts exceeded                         |                                               PendingUser + OTP session present | 1. Send invalid OTP repeatedly until max attempts reached (or mock increment)                                             | Registration blocked; appropriate error thrown; session may be invalidated or marked blocked; no user created.                                                                                                                                                                                      | High          |
| T14 | Duplicate referral code retry on save         | Referrer exists; `userRepo.existsByReferralCode()` returns true once then false | 1. Complete registration (valid OTP) while DB reports first generated referral code collision                             | System retries generation and eventually saves user with unique referral code; verify `userRepo.existsByReferralCode()` was called multiple times.                                                                                                                                                  | Medium        |
| T15 | Direct registration — no email provided       |                               No user with same username; valid referral exists | 1. Call service `directRegister(user w/ username only, referralCode)`                                                     | User saved; email auto-generated (`<username>@trustai.com`) and stored; hierarchy updated if referrer exists; event published.                                                                                                                                                                      | Medium        |
| T16 | Self-referral detection                       |                                       Trying to register with own referral code | 1. Simulate user whose referral code equals invite code (or save returns same id)                                         | Registration should fail with error and not leave a persisted invalid user. (Verify check occurs before final persist.)                                                                                                                                                                             | High          |
| T17 | Indirect referral cycle (A→B→A)               |              Hierarchy service supports cycle detection or DB has ancestor info | 1. Create referrer chain that would make cycle on new registration                                                        | System must detect cycle and reject registration OR hierarchy service should prevent cycle. If not supported, note as TODO.                                                                                                                                                                         | Medium        |
| T18 | Password hashing verification                 |                                                                 Pending created | 1. Create pending (T08) 2. Inspect PendingUser.passwordHash and final User.password                                       | Password stored hashed (not plain). On final User, stored password should be the hashed value from pending (or re-hashed if flow demands).                                                                                                                                                          | High          |
| T19 | Role & rank assignment                        |                                                         Role `ROLE_USER` exists | 1. Complete registration successfully                                                                                     | New user has `ROLE_USER` in roles and default rank (e.g., `RANK_0`) set.                                                                                                                                                                                                                            | Medium        |
| T20 | Event published & side effects                |                                       Messaging/event infra available or mocked | 1. Complete registration                                                                                                  | `UserRegisteredEvent` published; downstream listeners (e.g., leaderboard, analytics, welcome email) receive event / invoked.                                                                                                                                                                        | Low           |

### Quick execution tips
- Use deterministic test data (unique usernames/emails) to avoid DB collisions between runs.
- For OTP behavior, prefer mocking or a test mode to control OTP verification and attempt counters.
- Log or capture the OTP sessionId returned from create step and use it in verify step.
- For negative tests (referral collision, attempts exceeded), either use test doubles to force states or prepare DB rows to simulate conditions.
- Check DB for `pending_user` and `user` records after each test and clean up test data.